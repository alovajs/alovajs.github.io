"use strict";(self.webpackChunkalova_website=self.webpackChunkalova_website||[]).push([[782],{83480:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>o,toc:()=>c});var r=n(85893),i=n(11151);const s={title:"Atomize Requests"},a=void 0,o={id:"tutorial/server/strategy/atomize",title:"Atomize Requests",description:"server hook",source:"@site/docs/tutorial/04-server/01-strategy/04-atomize.md",sourceDirName:"tutorial/04-server/01-strategy",slug:"/tutorial/server/strategy/atomize",permalink:"/tutorial/server/strategy/atomize",draft:!1,unlisted:!1,editUrl:"https://github.com/alovajs/alovajs.github.io/blob/main/docs/tutorial/04-server/01-strategy/04-atomize.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{title:"Atomize Requests"},sidebar:"tutorial",previous:{title:"Request Rate Limit",permalink:"/tutorial/server/strategy/rate-limit"},next:{title:"Response Cache Details",permalink:"/tutorial/cache/"}},l={},c=[{value:"Features",id:"features",level:2},{value:"Usage",id:"usage",level:2},{value:"Basic Usage",id:"basic-usage",level:3},{value:"Customizing Lock Channel",id:"customizing-lock-channel",level:3},{value:"Customizing Timeout and Interval",id:"customizing-timeout-and-interval",level:3},{value:"Error Handling",id:"error-handling",level:3},{value:"Notes",id:"notes",level:2}];function d(e){const t={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(t.admonition,{title:"type",type:"info",children:[(0,r.jsx)(t.p,{children:"server hook"}),(0,r.jsx)(t.p,{children:"alova@3.4.0+"})]}),"\n",(0,r.jsxs)(t.blockquote,{children:["\n",(0,r.jsx)(t.p,{children:"The atomize strategy can be used to ensure atomicity of requests in multi-process environments."}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"features",children:"Features"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"Ensures atomicity of requests in multi-process environments;"}),"\n",(0,r.jsx)(t.li,{children:"Customizable lock channels, timeout, and retry intervals;"}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"usage",children:"Usage"}),"\n",(0,r.jsx)(t.h3,{id:"basic-usage",children:"Basic Usage"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-javascript",children:"const { atomize } = require('alova/server');\nconst { alovaInstance } = require('./api');\n\nconst res = await atomize(alovaInstance.Get('/api/user'));\n"})}),"\n",(0,r.jsxs)(t.p,{children:["By default, ",(0,r.jsx)(t.code,{children:"atomize"})," uses the channel name ",(0,r.jsx)(t.code,{children:"'default'"}),", a timeout of ",(0,r.jsx)(t.code,{children:"5000ms"}),", and a retry interval of ",(0,r.jsx)(t.code,{children:"100ms"}),"."]}),"\n",(0,r.jsx)(t.h3,{id:"customizing-lock-channel",children:"Customizing Lock Channel"}),"\n",(0,r.jsx)(t.p,{children:"You can specify a custom channel name or an array of channel names for locking, and different channels will not affect each other."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-javascript",children:"const hookedMethod = atomize(request, {\n  // highlight-start\n  // Set a custom channel name\n  channel: 'user_lock'\n  // Or multiple channels\n  // channel: ['user_lock', 'order_lock']\n  // highlight-end\n});\n"})}),"\n",(0,r.jsx)(t.h3,{id:"customizing-timeout-and-interval",children:"Customizing Timeout and Interval"}),"\n",(0,r.jsx)(t.p,{children:"You can adjust the timeout for acquiring the lock and the interval between retries."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-javascript",children:"const hookedMethod = atomize(request, {\n  // highlight-start\n  // Set timeout to 10 seconds\n  timeout: 10000,\n  // Set retry interval to 200ms\n  interval: 200\n  // highlight-end\n});\n"})}),"\n",(0,r.jsx)(t.h3,{id:"error-handling",children:"Error Handling"}),"\n",(0,r.jsx)(t.p,{children:"If the lock cannot be acquired within the specified timeout, an error will be thrown."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-javascript",children:"try {\n  const response = await atomize(request);\n} catch (error) {\n  console.error('Failed to acquire lock:', error.message);\n}\n"})}),"\n",(0,r.jsx)(t.h2,{id:"notes",children:"Notes"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["This strategy requires ",(0,r.jsx)(t.code,{children:"@alova/storage-redis"})," or ",(0,r.jsx)(t.code,{children:"@alova/storage-file"})," as the ",(0,r.jsx)(t.code,{children:"l2Cache"})," of the Alova instance."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"@alova/storage-redis"})," internally uses ",(0,r.jsx)(t.a,{href:"https://www.npmjs.com/package/@sesamecare-oss/redlock",children:"@sesamecare-oss/redlock"})," to implement a distributed lock. See the configuration for ",(0,r.jsx)(t.code,{children:"redlock"})," in the ",(0,r.jsx)(t.a,{href:"/resource/storage-adapter/redis",children:"redis storage adapter"})," documentation."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"@alova/storage-file"})," internally uses ",(0,r.jsx)(t.a,{href:"https://www.npmjs.com/package/proper-lockfile",children:"proper-lockfile"})," to implement a file-based lock. See the configuration for ",(0,r.jsx)(t.code,{children:"proper-lockfile"})," in the ",(0,r.jsx)(t.a,{href:"/resource/storage-adapter/file",children:"file storage adapter"})," documentation."]}),"\n",(0,r.jsx)(t.li,{children:"Ensure that the lock is released after the request is completed to avoid deadlocks."}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,i.a)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},11151:(e,t,n)=>{n.d(t,{Z:()=>o,a:()=>a});var r=n(67294);const i={},s=r.createContext(i);function a(e){const t=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(s.Provider,{value:t},e.children)}}}]);